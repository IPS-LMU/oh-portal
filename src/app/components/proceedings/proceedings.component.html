<ng-template #content let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Download Archive</h4>
        <button type="button" class="close" aria-label="Close" (click)="d()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p><a [href]="archiveURL">Download Archive</a></p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" (click)="c()">Close</button>
    </div>
</ng-template>

<div class="inner" (mouseleave)="isDragging = false" (dragover)="onDragOver($event)" (drop)="onDrop($event)"
     (click)="onContextBlur()">
    <div *ngIf="taskService.taskList.entries.length === 0" class="placeholder">
        <i class="fa" [ngClass]="{
            'fa-folder-open-o': isDragging,
            'fa-folder-o': !isDragging
        }"></i>
        <p class="description">
            Drag & drop some files/folders here or click on "+ ADD FILES"
        </p>
        <ul class="description">
            <li>You can add new files even if this message is not shown</li>
            <li>Adding folders and files is supported by the latest versions of Firefox, Chrome and Opera. <b>Safari is
                not supported</b></li>
            <li>Sub-folders will be shown on the first level</li>
            <li>You can add .wav files and combinations of .wav and transcript files. A transcript must have the same
                name as its .wav file
            </li>
        </ul>
    </div>
    <app-context-menu [ngStyle]="{
        'margin-top': contextmenu.y + 'px',
        'margin-left': contextmenu.x + 'px',
        'display': (contextmenu.hidden) ? 'none' : 'inherit'
    }" [hid]="contextmenu.hidden" [selected_tasks]="selected_tasks" [selectedOperationType]="selectedOperation"
                      (optionselected)="onContextMenuOptionSelected($event)">
    </app-context-menu>
    <app-popover [@fadeToggle]="popover.state"
                 [height]="popover.height"
                 [width]="popover.width"
                 [ngStyle]="{
        'width': popover.width + 'px',
        'height': popover.height + 'px',
        'margin-top': popover.y + 'px',
        'margin-left': (popover.x + 4) + 'px'
    }" (mouseover)="popover.state = 'opened';" (mouseout)="popover.state = 'closed';"
                 [borderColor]="getPopoverColor(popover.operation)" [pointer]="popover.pointer" #popoverRef>
        <ng-container *ngIf="popover.operation !== null">
            <ng-container *ngIf="popover.operation.time.start > 0">

                <p style="color:red;" *ngIf="popover.operation.lastResult !== null &&
                !popover.operation.lastResult.online
                ">
                    The latest result does not exist anymore.
                </p>

                <table class="timer">
                    <tr>
                        <td><i class="fa fa-clock-o" style="color: cornflowerblue;"></i> {{popover.operation.time.start
                            | date :"dd.MM.yyyy H:mm"}}
                        </td>
                        <td><i class="fa fa-hourglass-start" style="color: cornflowerblue;"></i>
                            {{calculateDuration(popover.operation.time) | time}}
                        </td>
                    </tr>
                </table>
            </ng-container>
            <ng-container *ngIf="popover.operation.results.length > 0">
                <div>
                    <app-results-table [operation]="popover.operation"></app-results-table>
                </div>
            </ng-container>
            <ng-container>
                <p style="font-size:12px;" [ngStyle]="{
                    color: getPopoverColor(popover.operation)
                }">
                    {{popover.operation.protocol}}
                </p>
            </ng-container>
        </ng-container>
        <ng-container *ngIf="popover.operation === null && popover.task !== null && popover.task !== undefined">

            <ng-container *ngIf="popover.task.state === 'FINISHED'">
                <!-- <a [href]="getMailToLink(popover.task)">Share results <i class="fa fa-envelope" aria-hidden="true"
                                                                         style="color:cornflowerblue;"></i></a> -->
            </ng-container>
            <span>Language: {{popover.task.language}}</span><br/><br/>
            <span>File infromation:</span>
            <app-file-info-table [fileinfo]="popover.task.files[0]"></app-file-info-table>
        </ng-container>
    </app-popover>
    <table class="table table-striped">
        <thead>
        <tr>
            <th></th>
            <th>File</th>
            <ng-container *ngFor="let operation of operations; let i = index" style="text-align: center;">
                <th>
                    <div>
                <span *ngIf="operation.icon === ''; else showIcon" style="display:block;"
                      (click)="openContentModal(operation)">
                    <ng-container *ngIf="shortstyle">
                        {{operation.name.charAt(0)}}
                    </ng-container>
                    <ng-container *ngIf="!shortstyle">
                        {{operation.name}}
                    </ng-container>
                </span>
                        <ng-template #showIcon>
                            <div [innerHTML]="operation.icon" (click)="openContentModal(operation)"></div>
                        </ng-template>
                        <input *ngIf="operation.name === 'OCTRA' || operation.name === 'ASR'" type="checkbox"
                               class="header-checkbox"
                               [checked]="operation.enabled" (click)="deactivateOperation(operation, i)"/>
                    </div>
                </th>
            </ng-container>
        </tr>
        </thead>
        <tbody (contextmenu)="onContextMenu($event)">
        <ng-container *ngFor="let entry of taskList.entries; let i = index;">

            <tr style="cursor:pointer;" [ngClass]="{'selected': (isEntrySelected(entry))}">
                <td *ngIf="entry.files !== undefined" style="width:25px;">
                    <i class="fa fa-file-audio-o"
                       aria-hidden="true"
                       [ngClass]="{
            green: (entry.state === 'FINISHED'),
            red: (entry.state === 'ERROR'),
            blue: (entry.state === 'PENDING' || entry.state === 'READY'),
            yellow: (entry.state === 'PROCESSING')
            }"></i></td>
                <td *ngIf="entry.files === undefined" (click)="onRowSelected(entry)" style="width:25px;"><i
                        class="fa fa-folder-open blue"
                        aria-hidden="true"></i>
                </td>
                <td *ngIf="entry.files !== undefined" (click)="onRowSelected(entry)"
                    [ngClass]="{
                            'shorten': shortstyle
                        }">
                <span [ngClass]="{
                    'green': entry.files[0].file !== undefined,
                    'yellow': (entry.files[0].file === undefined && entry.operations[0].results.length === 0)
                }" title="{{entry.files[0].fullname}}"
                      (mouseenter)="onTaskMouseEnter($event, entry)"
                      (mouseleave)="onTaskMouseLeave($event, entry)"
                      (mouseover)="onTaskMouseOver($event, entry)">
                <ng-container *ngIf="!(entry.files[0].file === undefined && entry.operations[0].results.length === 0)">
                            {{entry.files[0].fullname}}
                        </ng-container>
                        <ng-container
                                *ngIf="(entry.files[0].file === undefined && entry.operations[0].results.length === 0)">
                            {{entry.files[0].attributes.originalFileName}}
                        </ng-container>
                </span>
                    <ng-container *ngIf=" entry.files.length > 1">
                    <span class="badge" [ngClass]="
                    {
                        'badge-info': entry.files[1].file !== undefined || entry.operations[0].results.length > 1,
                        'badge-warning': !(entry.files[1].file !== undefined || entry.operations[0].results.length > 1)
                    }
">{{taskService.getAppendingsExtension(entry.files[1])}}</span>
                    </ng-container>
                </td>

                <td *ngIf="entry.files === undefined" [attr.colspan]="taskService.operations.length + 1"
                    (click)="onRowSelected(entry)">
                <span title="{{entry.foldername}}">
                {{entry.foldername}}
                </span>
                    <span *ngIf="entry.entries.length > 0">
                    ({{entry.entries.length}})
                </span>
                </td>

                <ng-container *ngIf="entry.files !== undefined">
                    <td *ngFor="let operation of entry.operations" style="text-align: center;" [ngClass]="{
                'op-deactivated': !operation.enabled
            }"
                        (mouseenter)="onOperationMouseEnter($event, operation)"
                        (mouseleave)="onOperationMouseLeave($event, operation)"
                        (mouseover)="onOperationMouseOver($event, operation)"
                        (mousedown)="onOperationClick($event, operation)"
                    >
                        <ng-container
                                *ngIf="(operation.state === 'FINISHED' && operation.results.length > 0 && !operation.results[operation.results.length-1].online) || ((operation.name === 'OCTRA' || operation.name == 'EmuWebapp') && entry.operations[0].lastResult !== null && !entry.operations[0].lastResult.online); else elseBlock">
                            <i class="fa fa-chain-broken"
                               aria-hidden="true"></i>
                        </ng-container>
                        <ng-template #elseBlock>
                            <div *ngIf="!(operation.mouseover && operation.state === 'ERROR')"
                                 [innerHTML]="getStateIcon(operation)"
                                 (click)="onRowSelected(entry, operation)"></div>
                            <div *ngIf="operation.mouseover && operation.state === 'ERROR'">
                                <i class="fa fa-repeat" aria-hidden="true"
                                   (click)="entry.restartFailedOperation(taskService.httpclient);"></i>
                            </div>
                            <div *ngIf="!operation.enabled">
                                <i class="fa fa-arrow-circle-right" style="color:white" aria-hidden="true"></i>
                            </div>
                        </ng-template>

                    </td>
                </ng-container>
            </tr>
            <ng-container *ngIf="entry.files === undefined">
                <tr *ngFor="let dirEntry of entry.entries" [ngClass]="{'selected': (isEntrySelected(dirEntry))}">
                    <td>
                        <img style="height:20px;" src="./assets/directory.png">
                    </td>
                    <td (click)="onRowSelected(dirEntry)">
                        <i class="fa fa-file-audio-o" aria-hidden="true"
                           [ngClass]="{
            green: (dirEntry.state === 'FINISHED'),
            red: (dirEntry.state === 'ERROR'),
            blue: (dirEntry.state === 'PENDING' || dirEntry.state === 'READY'),
            yellow: (dirEntry.state === 'PROCESSING')
            }"></i> <span
                            (mouseenter)="onTaskMouseEnter($event, dirEntry)"
                            (mouseleave)="onTaskMouseLeave($event, dirEntry)"
                            (mouseover)="onTaskMouseOver($event, dirEntry)"
                            [ngClass]="{
                    'green': dirEntry.files[0].file !== undefined,
                    'yellow': (dirEntry.files[0].file === undefined && dirEntry.operations[0].results.length === 0)
                }">
                        <ng-container
                                *ngIf="!(dirEntry.files[0].file === undefined && dirEntry.operations[0].results.length === 0)">
                            {{dirEntry.files[0].fullname}}
                        </ng-container>
                        <ng-container
                                *ngIf="(dirEntry.files[0].file === undefined && dirEntry.operations[0].results.length === 0)">
                            {{dirEntry.files[0].attributes?.originalFileName}}
                        </ng-container>
                    </span>
                        <ng-container *ngIf="dirEntry.files.length > 1">
                            <span class="badge" [ngClass]="
                            {
                                'badge-info': (dirEntry.files[1].file !== undefined || dirEntry.operations[0].results.length > 1),
                                'badge-warning': !(dirEntry.files[1].file !== undefined || dirEntry.operations[0].results.length > 1)
                            }
        ">{{taskService.getAppendingsExtension(dirEntry.files[1])}}</span>
                        </ng-container>
                    </td>
                    <td *ngFor="let operation of dirEntry.operations" style="text-align: center;" [ngClass]="{
                'op-deactivated': !operation.enabled
            }"
                        (click)="onRowSelected(dirEntry, operation)"
                        (mouseenter)="onOperationMouseEnter($event, operation)"
                        (mouseleave)="onOperationMouseLeave($event, operation)"
                        (mouseover)="onOperationMouseOver($event, operation)"
                        (mousedown)="onOperationClick($event, operation)"
                    >
                        <ng-container
                                *ngIf="(operation.state === 'FINISHED' && operation.results.length > 0 && !operation.results[operation.results.length-1].online) || ((operation.name === 'OCTRA' || operation.name == 'Emu WebApp') && dirEntry.operations[0].lastResult !== null && !dirEntry.operations[0].lastResult.online); else elseBlock">
                            <i class="fa fa-chain-broken"
                               aria-hidden="true"></i>
                        </ng-container>
                        <ng-template #elseBlock>
                            <div *ngIf="!(operation.mouseover && operation.state === 'ERROR')"
                                 [innerHTML]="getStateIcon(operation)"
                                 (click)="onRowSelected(dirEntry, operation)"></div>
                            <div *ngIf="operation.mouseover && operation.state === 'ERROR'">
                                <i class="fa fa-repeat" aria-hidden="true"
                                   (click)="dirEntry.restartFailedOperation(taskService.httpclient);"></i>
                            </div>
                            <div *ngIf="!operation.enabled">
                                <i class="fa fa-arrow-circle-right" style="color:white" aria-hidden="true"></i>
                            </div>
                        </ng-template>
                    </td>
                </tr>
            </ng-container>
        </ng-container>
        <ng-container *ngFor="let entry of queue; let i = index;">
            <tr style="cursor:pointer;" [ngClass]="{'selected': (isEntrySelected(entry))}">
                <td *ngIf="entry.file.entries === undefined" style="width:25px;">
                    <i class="fa fa-file-audio-o op-50"
                       aria-hidden="true">
                    </i>
                </td>
                <td *ngIf="entry.file.entries !== undefined" style="width:25px;">
                    <i class="fa fa-folder-open blue op-50" aria-hidden="true"></i>
                </td>
                <td *ngIf="entry.file.entries === undefined"
                    [ngClass]="{'shorten': shortstyle}">
                    <span class="op-50"
                          title="{{entry.file.fullname}}"
                    >
                        {{entry.file.fullname}}
                    </span>
                </td>
                <td *ngIf="entry.file.entries !== undefined" [attr.colspan]="taskService.operations.length + 1">
                    <span title="{{entry.file.name}}" class="op-50">{{entry.file.name}}
                    </span>
                    <span *ngIf="entry.file.entries.length > 0" class="op-50">
                    ({{entry.file.entries.length}})
                    </span>
                </td>
                <ng-container *ngIf="entry.file.entries === undefined">
                    <td [attr.colspan]="taskService.operations.length + 1"></td>
                </ng-container>
            </tr>
            <ng-container *ngIf="entry.file.entries !== undefined">
                <tr *ngFor="let dirEntry of entry.file.entries">
                    <td>
                        <img style="height:20px;" src="./assets/directory.png" class="op-50">
                    </td>
                    <td>
                        <i class="fa fa-file-audio-o op-50" aria-hidden="true"></i>
                        <span class="op-50">{{dirEntry.fullname}}</span>
                    </td>
                    <td [attr.colspan]="taskService.operations.length + 1"></td>
                </tr>
            </ng-container>
        </ng-container>
        </tbody>
    </table>
</div>