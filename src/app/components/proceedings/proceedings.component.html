<app-download-modal #content [selectedTasks]="selectedRows" [column]="selectedOperation"></app-download-modal>

<app-file-preview-modal #filePreview></app-file-preview-modal>
<div class="inner" (mouseleave)="isDragging = false" (dragover)="onDragOver($event)" (drop)="onDrop($event)"
     (click)="onContextBlur()">
    <div *ngIf="!storage.tasksFound && taskService.taskList.entries.length === 0 && queue.length === 0"
         class="placeholder">
        <h1 style="margin-top: 10%;margin-bottom:40px;">Quickstart</h1>
        <div class="row quickstart" style="padding:20px 20px;">
            <div class="col-4">
                <div style="width:80px; height:80px; margin: 0 auto;">
                    <div class="rounded-circle"
                         style="background-color:cornflowerblue;width:80px; height:80px; color:white; text-align:center;vertical-align:middle;font-size:2em;display:table-cell;margin:0 auto;">
                        1.
                    </div>
                </div>
                <h4>Add files</h4>
                <p>You can drag & drop files (.wav & transcripts) to this whole area (inside the dashed rectangle) or
                    you can use the "1. ADD
                    FILES" button. Later, you can add files via drag & drop to the table rows, too.</p>
            </div><!-- /.col-lg-4 -->
            <div class="col-4">
                <div style="width:80px; height:80px; margin: 0 auto;">
                    <div class="rounded-circle"
                         style="background-color:cornflowerblue;width:80px; height:80px; color:white; text-align:center;vertical-align:middle;font-size:2em;display:table-cell;margin:0 auto;">
                        2.
                    </div>
                </div>
                <h4>Verify new files</h4>
                <p>Before the new files can be processed it's required to set few options. Click on the "2. Verify"
                    Button.</p>
            </div><!-- /.col-lg-4 -->
            <div class="col-4">
                <div style="width:80px; height:80px; margin: 0 auto;">
                    <div class="rounded-circle"
                         style="background-color:cornflowerblue;width:80px; height:80px; color:white; text-align:center;vertical-align:middle;font-size:2em;display:table-cell;margin:0 auto;">
                        3.
                    </div>
                </div>
                <h4>Start Processing</h4>
                <p>After all files are verified you can click on "START PROCESSING". The application starts the
                    processing of pending tasks.</p>
            </div><!-- /.col-lg-4 -->
        </div>
    </div>
    <div id="loading" *ngIf="storage.tasksFound && !storage.ready">
        <i class="fa fa-spinner fa-spin fa-5x"></i>
    </div>
    <ng-container *ngIf="storage.ready">
        <app-context-menu [ngStyle]="{
        'margin-top': contextmenu.y + 'px',
        'margin-left': contextmenu.x + 'px',
        'display': (contextmenu.hidden) ? 'none' : 'inherit'
    }" [hid]="contextmenu.hidden" [selected_tasks]="selectedRows" [selectedOperationType]="selectedOperation"
                          (optionselected)="onContextMenuOptionSelected($event)">
        </app-context-menu>
        <app-popover [@fadeToggle]="popover.state"
                     [height]="popover.height"
                     [width]="popover.width"
                     [ngStyle]="{
        'width': popover.width + 'px',
        'height': popover.height + 'px',
        'margin-top': popover.y + 'px',
        'margin-left': (popover.x + 4) + 'px'
    }" (mouseenter)="popover.mouseIn = true"
                     (mouseleave)="popover.state = 'closed'"
                     [borderColor]="getPopoverColor(popover.operation)" [pointer]="popover.pointer" #popoverRef>
            <ng-container *ngIf="popover.operation !== null">
                <ng-container *ngIf="popover.operation.time.start > 0">

                    <p style="color:red;" *ngIf="popover.operation.lastResult !== null &&
                !popover.operation.lastResult.available
                ">
                        The latest result does not exist anymore.
                    </p>

                    <table class="timer">
                        <tr>
                            <td><i class="fa fa-clock-o" style="color: cornflowerblue;"></i>
                                {{popover.operation.time.start
                                    | date :"dd.MM.yyyy H:mm"}}
                            </td>
                            <td><i class="fa fa-hourglass-start" style="color: cornflowerblue;"></i>
                                {{calculateDuration(popover.operation.time) | time:'true'}}
                            </td>
                        </tr>
                    </table>
                </ng-container>
                <ng-container *ngIf="popover.operation.results.length === 0 && popover.operation.providerInformation !== undefined">
                    <div class="service-preview">
                        <div class="provided-by">Service provided by</div>
                        <a href="https://www.eml.org/" target="_blank" style="display:block;vertical-align: middle;">
                            <img class="service-logo" [src]="popover.operation.providerInformation.logoURL" alt="EML Logo">
                        </a>
                        <div class="service-terms">
                            <a href="https://www.phonetik.uni-muenchen.de/Bas/BasLSTRadboutUniDisclaimer.txt"
                               target="_blank"><i class="fa fa-handshake-o"></i> Service terms</a>
                        </div>
                        <i class="fa fa-exclamation-circle report-issue" (click)="onReportIconClick(popover.operation)"></i>
                    </div>
                    <div class="service-remarks">
                        <ul>
                            <li>The processing time is dependent on the service provider.</li>
                            <li>As soon as the service has finished processing the result appears here.</li>
                            <li>{{popover.operation.providerInformation.dataStoragePolicy}}</li>
                        </ul>
                    </div>
                    <div class="clearfix"></div>
                </ng-container>
                <ng-container *ngIf="popover.operation.results.length > 0">
                    <div style="overflow:auto;">
                        <app-results-table [operation]="popover.operation"
                                           (previewClick)="onPreviewClick($event)"></app-results-table>
                    </div>
                </ng-container>
                <ng-container *ngIf="popover.operation.protocol !== ''">
                    <div style="width:100%;text-align:right;padding:0;margin-bottom:0;">
                        <button style="font-size:11px;cursor:pointer;margin-bottom:0;"
                                (click)="copyProtocolToClipboard(popover.operation.protocol)">
                            <i class="fa fa-clipboard"></i> Copy to clipboard
                        </button>
                    </div>
                    <p [innerHTML]="popover.operation.protocol" style="font-size:11px;cursor:pointer;padding:0;margin-top:-10px;" [ngStyle]="{
                    color: getPopoverColor(popover.operation)
                }"></p>
                </ng-container>
            </ng-container>
            <ng-container
                    *ngIf="popover.operation === null && popover.task !== null && popover.task !== undefined && popover.task.entries === undefined">
                <ng-container *ngIf="popover.task.state === 'FINISHED'">
                    <!-- <a [href]="getMailToLink(popover.task)">Share results <i class="fa fa-envelope" aria-hidden="true"
                                                                             style="color:cornflowerblue;"></i></a> -->
                </ng-container>
                <span>Language: {{popover.task.language}}</span>
                <span *ngIf="popover.task.asr !== undefined && popover.task.asr !== null">
                    , ASR: {{popover.task.asr}}
                </span>
                <br/><br/>
                <span>File information:</span>
                <app-file-info-table
                        [fileinfo]="(popover.task.files) ? popover.task.files[0] : null"></app-file-info-table>
            </ng-container>
        </app-popover>

        <!-- Big proceedings table -->
        <table class="table table-striped">
            <!-- TABLE HEADER -->
            <thead>
            <tr class="tableHeaderTop">
                <th (click)="onOpenAllRows()" style="width:15px; padding-right:0;text-align:center; cursor:pointer;">
                    <i *ngIf="allDirOpened === 'opened'" class="fa fa-angle-up"></i>
                    <i *ngIf="allDirOpened === 'closed'" class="fa fa-angle-down"></i>
                </th>
                <th>File</th>
                <ng-container *ngFor="let operation of operations; let i = index" style="text-align: center;">
                    <th style="padding-left:3px;padding-right:3px;" [ngClass]="
{
    'bigCol': (!shortstyle)
}">
                        <div style="position: relative;">
                            <div style="display:block;position: relative;height:25px;cursor:pointer;">
                                <app-operation-arrow [first]="(i === 0)"
                                                     [type]="(i === operations.length - 1) ? 'circle': 'arrow'"></app-operation-arrow>
                                <div style="z-index:10;width:100%;text-align:center;">
                                    <ng-template #tipContent>{{operation.description}}</ng-template>
                                    <div style="display:inline;padding:0 3px;"

                                         (click)="openArchiveDownload('column', operation)" [ngbTooltip]="tipContent"
                                         tooltipClass="operation-tooltip"
                                         triggers="manual" #t2="ngbTooltip" placement="bottom"
                                         (mouseenter)="toolTipAction('open', t2)"
                                         (mouseleave)="toolTipAction('close', t2)"
                                    >
                                        <ng-container *ngIf="shortstyle">
                                            {{operation.shortTitle}}
                                        </ng-container>
                                        <ng-container *ngIf="!shortstyle">
                                            {{operation.title}}
                                        </ng-container>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th>
                </ng-container>
            </tr>
            <tr class="subTableHeader">
                <th style="width:15px; padding-right:0;text-align:center;">
                </th>
                <th></th>
                <ng-container *ngFor="let operation of operations; let i = index" style="text-align: center;">
                    <th *ngIf="operation.name === 'OCTRA' || operation.name === 'ASR'">
                        <input type="checkbox"
                               class="header-checkbox"
                               [checked]="operation.enabled" (click)="deactivateOperation(operation, i)"/>
                    </th>
                    <th *ngIf="operation.name === 'MAUS'" colspan="2" style="position: relative">
                        <img src="assets/directory.png" style="height:25px;left:0;position:absolute"/>
                        <input type="checkbox"
                               class="header-checkbox"
                               [checked]="operation.enabled" (click)="deactivateOperation(operation, i)"/>
                        <img src="assets/directory.png"
                             style="height:25px;-webkit-transform: scaleX(-1); transform: scaleX(-1);right:0;position:absolute"/>
                    </th>
                    <th *ngIf="i === 0"></th>
                </ng-container>
            </tr>
            </thead>

            <!-- TABLE BODY -->
            <tbody (contextmenu)="onContextMenu($event)">
            <ng-container *ngFor="let entry of taskList.entries; let i = index;">
                <tr appProceedingsRow [entry]="entry" [toolSelectedOperation]="toolSelectedOperation"
                    [rowSelected]="isEntrySelected(entry)">
                    <!-- filename/foldername column -->
                    <!-- <td (click)="tagClicked(nameCol)" style="width:15px; padding-right:0;text-align:center; cursor:pointer;">
                        <i *ngIf="entry.type === 'folder' && nameCol.dirOpened === 'opened'"
                           class="fa fa-angle-up"></i>
                        <i *ngIf="entry.type === 'folder' && nameCol.dirOpened === 'closed'"
                           class="fa fa-angle-down"></i>
                    </td> -->
                    <td appProcColIcon [entry]="entry" [shortStyle]="shortstyle"
                        (appendingClick)="onPreviewClick($event)"
                        (click)="onRowSelected(entry)"
                        (infoMouseEnter)="onInfoMouseEnter($event, entry, td)"
                        (infoMouseLeave)="onInfoMouseLeave($event, entry)"
                        (infoMouseOver)="onInfoMouseOver($event, entry)"
                        (deleteIconClick)="removeEntry($event, entry)"
                        (mouseenter)="onNameMouseEnter($event, entry, td)"
                        (mouseleave)="onNameMouseLeave($event, entry)"
                        (mouseover)="onNameMouseOver($event, entry)"
                        [mouseOver]="entry.mouseover"
                        #nameCol="colIcon"
                        [dirOpened]="allDirOpened"
                        (tagClicked)="onTagClicked($event)"
                    >
                    </td>
                    <!-- Task operations-->
                    <ng-container *ngIf="entry.type === 'task'">
                        <td *ngFor="let operation of entry.operations" appProcColOperation

                            [entry]="entry"
                            [operation]="operation"

                            (onOperationMouseEnter)="onOperationMouseEnter($event, operation)"
                            (onOperationMouseLeave)="onOperationMouseLeave($event, operation)"
                            (onOperationMouseOver)="onOperationMouseOver($event, operation)"
                            (mousedown)="onOperationClick($event, operation)"
                            (click)="onRowSelected(entry, operation)"
                        >
                        </td>
                    </ng-container>
                    <ng-container *ngIf="entry.type === 'folder'">
                        <td *ngFor="let operation of taskService.operations; let opIndex = index"
                            (click)="onRowSelected(entry)">
                            <div class="progress">
                                <div appDirProgress [dir]="entry" [opIndex]="opIndex" class="progress-bar"
                                     role="progressbar" aria-valuemin="0" aria-valuemax="100">25%
                                </div>
                            </div>
                        </td>
                    </ng-container>
                </tr>
                <ng-container *ngIf="entry.type === 'folder'">
                    <!-- folder row -->
                    <tr *ngFor="let dirEntry of entry.entries" appProceedingsRow
                        [entry]="dirEntry"
                        [toolSelectedOperation]="toolSelectedOperation"
                        [rowSelected]="isEntrySelected(dirEntry)"
                        [@fadeToggle]="nameCol.dirOpened"
                    >
                        <td appProcColIcon
                            [shortStyle]="shortstyle"
                            (click)="onRowSelected(dirEntry)" #td
                            [entry]="dirEntry"
                            (infoMouseEnter)="onInfoMouseEnter($event, dirEntry, td)"
                            (infoMouseLeave)="onInfoMouseLeave($event, dirEntry)"
                            (infoMouseOver)="onInfoMouseOver($event, dirEntry)"
                            (deleteIconClick)="removeEntry($event, dirEntry)"
                            (mouseenter)="onNameMouseEnter($event, dirEntry, td)"
                            (mouseleave)="onNameMouseLeave($event, dirEntry)"
                            (mouseover)="onNameMouseOver($event, dirEntry)"
                            [mouseOver]="dirEntry.mouseover"
                        >
                        </td>
                        <ng-container *ngIf="entry.type === 'task'">
                            <td *ngFor="let operation of entry.operations" appProcColOperation

                                [entry]="entry"
                                [operation]="operation"

                                (onOperationMouseEnter)="onOperationMouseEnter($event, operation)"
                                (onOperationMouseLeave)="onOperationMouseLeave($event, operation)"
                                (onOperationMouseOver)="onOperationMouseOver($event, operation)"
                                (mousedown)="onOperationClick($event, operation)"
                                (click)="onRowSelected(entry, operation)"
                            >
                            </td>
                        </ng-container>
                        <td *ngFor="let operation of dirEntry.operations" appProcColOperation

                            [entry]="dirEntry"
                            [operation]="operation"

                            (onOperationMouseEnter)="onOperationMouseEnter($event, operation)"
                            (onOperationMouseLeave)="onOperationMouseLeave($event, operation)"
                            (onOperationMouseOver)="onOperationMouseOver($event, operation)"
                            (mousedown)="onOperationClick($event, operation)"
                            (click)="onRowSelected(dirEntry, operation)">
                        </td>
                    </tr>
                </ng-container>
            </ng-container>
            <!-- Queue rows -->
            <ng-container *ngFor="let entry of queue; let i = index;">
                <tr style="cursor:pointer;" [ngClass]="{'selected': (isEntrySelected(entry))}">
                    <td *ngIf="entry.file.entries === undefined"
                        [ngClass]="{'shorten': shortstyle}" [attr.colspan]="taskService.operations.length + 1">
                        <ng-container *ngIf="entry.file.entries === undefined">
                            <i class="fa fa-database op-50"
                               aria-hidden="true">
                            </i>
                        </ng-container>
                        <ng-container *ngIf="entry.file.entries !== undefined" [ngClass]="{
                            'shorten': shortstyle
                        }">
                            <i class="fa fa-folder-open blue op-50" aria-hidden="true"></i>
                        </ng-container>
                        <span class="op-50"
                              title="{{entry.file.fullname}}"
                        >
                            {{entry.file.fullname}}  <i class="fa fa-spinner fa-spin"></i>
                        </span>
                    </td>
                    <td *ngIf="entry.file.entries !== undefined" [attr.colspan]="taskService.operations.length + 1">
                        <span title="{{entry.file.name}}" class="op-50">{{entry.file.name}}  <i
                                class="fa fa-spinner fa-spin"></i>
                        </span>
                    </td>
                    <ng-container *ngIf="entry.file.entries === undefined">
                        <td [attr.colspan]="taskService.operations.length + 1"></td>
                    </ng-container>
                </tr>
                <ng-container *ngIf="entry.file.entries !== undefined">
                    <tr *ngFor="let dirEntry of entry.file.entries">
                        <td>
                            <i class="fa fa-database op-50" aria-hidden="true"></i>
                            <span class="op-50">{{dirEntry.fullname}}</span> <i class="fa fa-spinner fa-spin"></i>
                        </td>
                        <td [attr.colspan]="taskService.operations.length + 1"></td>
                    </tr>
                </ng-container>
            </ng-container>
            </tbody>
        </table>
    </ng-container>
</div>