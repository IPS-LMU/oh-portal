<app-download-modal #content [selectedTasks]="selectedRows" [column]="selectedOperation"></app-download-modal>

<app-file-preview-modal #filePreview></app-file-preview-modal>

<div class="inner" (mouseleave)="isDragging = false" (dragover)="onDragOver($event)" (drop)="onDrop($event)"
     (click)="onContextBlur()">
    <div *ngIf="!storage.tasksFound && taskService.taskList.entries.length === 0 && queue.length === 0"
         class="placeholder">
        <i class="fa" [ngClass]="{
            'fa-folder-open-o': isDragging,
            'fa-folder-o': !isDragging
        }"></i>
        <p class="description">
            Drag & drop some files/folders here or click on "+ ADD FILES"
        </p>
        <ul class="description">
            <li>You can add new files even if this message is not shown</li>
            <li>Adding folders and files is supported by the latest versions of Firefox, Chrome and Opera. <b>Safari is
                not supported</b></li>
            <li>Sub-folders will be shown on the first level</li>
            <li>You can add .wav files and combinations of .wav and transcript files. A transcript must have the same
                name as its .wav file
            </li>
        </ul>
    </div>
    <div id="loading" *ngIf="storage.tasksFound && !storage.ready">
        <i class="fa fa-spinner fa-spin fa-5x"></i>
    </div>
    <ng-container *ngIf="storage.ready">
        <app-context-menu [ngStyle]="{
        'margin-top': contextmenu.y + 'px',
        'margin-left': contextmenu.x + 'px',
        'display': (contextmenu.hidden) ? 'none' : 'inherit'
    }" [hid]="contextmenu.hidden" [selected_tasks]="selectedRows" [selectedOperationType]="selectedOperation"
                          (optionselected)="onContextMenuOptionSelected($event)">
        </app-context-menu>
        <app-popover [@fadeToggle]="popover.state"
                     [height]="popover.height"
                     [width]="popover.width"
                     [ngStyle]="{
        'width': popover.width + 'px',
        'height': popover.height + 'px',
        'margin-top': popover.y + 'px',
        'margin-left': (popover.x + 4) + 'px'
    }" (mouseover)="popover.state = 'opened';" (mouseout)="popover.state = 'closed';"
                     [borderColor]="getPopoverColor(popover.operation)" [pointer]="popover.pointer" #popoverRef>
            <ng-container *ngIf="popover.operation !== null">
                <ng-container *ngIf="popover.operation.time.start > 0">

                    <p style="color:red;" *ngIf="popover.operation.lastResult !== null &&
                !popover.operation.lastResult.available
                ">
                        The latest result does not exist anymore.
                    </p>

                    <table class="timer">
                        <tr>
                            <td><i class="fa fa-clock-o" style="color: cornflowerblue;"></i>
                                {{popover.operation.time.start
                                | date :"dd.MM.yyyy H:mm"}}
                            </td>
                            <td><i class="fa fa-hourglass-start" style="color: cornflowerblue;"></i>
                                {{calculateDuration(popover.operation.time) | time}}
                            </td>
                        </tr>
                    </table>
                </ng-container>
                <ng-container *ngIf="popover.operation.results.length > 0">
                    <div style="overflow:auto;">
                        <app-results-table [operation]="popover.operation"
                                           (previewClick)="onPreviewClick($event)"></app-results-table>
                    </div>
                </ng-container>
                <ng-container>
                    <p style="font-size:12px;" [ngStyle]="{
                    color: getPopoverColor(popover.operation)
                }">
                        {{popover.operation.protocol}}
                    </p>
                </ng-container>
            </ng-container>
            <ng-container *ngIf="popover.operation === null && popover.task !== null && popover.task !== undefined">
                <ng-container *ngIf="popover.task.state === 'FINISHED'">
                    <!-- <a [href]="getMailToLink(popover.task)">Share results <i class="fa fa-envelope" aria-hidden="true"
                                                                             style="color:cornflowerblue;"></i></a> -->
                </ng-container>
                <span>Language: {{popover.task.language}}</span><br/><br/>
                <span>File information:</span>
                <app-file-info-table
                        [fileinfo]="(popover.task.files) ? popover.task.files[0] : null"></app-file-info-table>
            </ng-container>
        </app-popover>

        <!-- Big proceedings table -->
        <table class="table table-striped">
            <!-- TABLE HEADER -->
            <thead>
            <tr class="tableHeaderTop">
                <th>File</th>
                <ng-container *ngFor="let operation of operations; let i = index" style="text-align: center;">
                    <th style="padding-left:3px;padding-right:3px;" [title]="operation.name">
                        <div style="position: relative;">
                            <div style="display:block;position: relative;height:25px;">
                                <app-operation-arrow [first]="(i === 0)"
                                                     [type]="(i === operations.length - 1) ? 'circle': 'arrow'"></app-operation-arrow>
                                <div style="position:absolute;z-index:10;width:100%;text-align:center;">
                                <span style="background-color:white;padding:0px 3px;"
                                      *ngIf="operation.icon === ''; else showIcon"

                                      (click)="openArchiveDownload('column', operation)">
                                    <ng-container *ngIf="shortstyle">
                                        {{operation.name.charAt(0)}}
                                    </ng-container>
                                    <ng-container *ngIf="!shortstyle">
                                        {{operation.name}}
                                    </ng-container>
                                 </span>
                                    <ng-template #showIcon>
                                    <span style="background-color:white;padding:0px 3px;"
                                          [innerHTML]="operation.icon"
                                          (click)="openArchiveDownload('column', operation)">
                                    </span>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                    </th>
                </ng-container>
            </tr>
            <tr class="subTableHeader">
                <th></th>
                <ng-container *ngFor="let operation of operations; let i = index" style="text-align: center;">
                    <th *ngIf="operation.name === 'OCTRA' || operation.name === 'ASR'">
                        <input type="checkbox"
                               class="header-checkbox"
                               [checked]="operation.enabled" (click)="deactivateOperation(operation, i)"/>
                    </th>
                    <th *ngIf="operation.name === 'MAUS'" colspan="2" style="position: relative">
                        <img src="assets/directory.png" style="height:25px;left:0;position:absolute"/>
                        <input type="checkbox"
                               class="header-checkbox"
                               [checked]="operation.enabled" (click)="deactivateOperation(operation, i)"/>
                        <img src="assets/directory.png"
                             style="height:25px;-webkit-transform: scaleX(-1); transform: scaleX(-1);right:0;position:absolute"/>
                    </th>
                    <th *ngIf="i === 0"></th>
                </ng-container>
            </tr>
            </thead>

            <!-- TABLE BODY -->
            <tbody (contextmenu)="onContextMenu($event)">
            <ng-container *ngFor="let entry of taskList.entries; let i = index;">
                <tr appProceedingsRow [entry]="entry" [toolSelectedOperation]="toolSelectedOperation"
                    [rowSelected]="isEntrySelected(entry)">
                    <!-- filename/foldername column -->
                    <td appProcColIcon [entry]="entry" [shortStyle]="shortstyle"
                        (onAppendingClick)="onPreviewClick($event)"
                        (click)="onRowSelected(entry)"
                        (onInfoMouseEnter)="onInfoMouseEnter($event, entry, td)"
                        (onInfoMouseLeave)="onInfoMouseLeave($event, entry)"
                        (onInfoMouseOver)="onInfoMouseOver($event, entry)"
                        (onDeleteIconClick)="removeEntry($event, entry)"
                        (mouseenter)="onNameMouseEnter($event, entry, td)"
                        (mouseleave)="onNameMouseLeave($event, entry)"
                        (mouseover)="onNameMouseOver($event, entry)"
                        [mouseover]="entry.mouseover">
                    </td>
                    <!-- Task operations-->
                    <ng-container *ngIf="entry.files !== undefined">
                        <td *ngFor="let operation of entry.operations" appProcColOperation

                            [entry]="entry" w
                            [operation]="operation"

                            (mouseenter)="onOperationMouseEnter($event, operation)"
                            (mouseleave)="onOperationMouseLeave($event, operation)"
                            (mouseover)="onOperationMouseOver($event, operation)"
                            (mousedown)="onOperationClick($event, operation)"
                            (click)="onRowSelected(entry, operation)"
                        >
                        </td>
                    </ng-container>
                </tr>
                <ng-container *ngIf="entry.files === undefined">
                    <!-- folder row -->
                    <tr *ngFor="let dirEntry of entry.entries" appProceedingsRow
                        [entry]="dirEntry"
                        [toolSelectedOperation]="toolSelectedOperation"
                        [rowSelected]="isEntrySelected(dirEntry)"
                    >
                        <td appProcColIcon [shortStyle]="shortstyle"
                            (click)="onRowSelected(dirEntry)" #td
                            [entry]="dirEntry"
                            (onInfoMouseEnter)="onInfoMouseEnter($event, dirEntry, td)"
                            (onInfoMouseLeave)="onInfoMouseLeave($event, dirEntry)"
                            (onInfoMouseOver)="onInfoMouseOver($event, dirEntry)"
                            (onDeleteIconClick)="removeEntry($event, dirEntry)"
                            (mouseenter)="onNameMouseEnter($event, dirEntry, td)"
                            (mouseleave)="onNameMouseLeave($event, dirEntry)"
                            (mouseover)="onNameMouseOver($event, dirEntry)"
                            [mouseover]="dirEntry.mouseover"
                        >
                        </td>
                        <ng-container *ngIf="entry.files !== undefined">
                            <td *ngFor="let operation of entry.operations" appProcColOperation

                                [entry]="entry"
                                [operation]="operation"

                                (mouseenter)="onOperationMouseEnter($event, operation)"
                                (mouseleave)="onOperationMouseLeave($event, operation)"
                                (mouseover)="onOperationMouseOver($event, operation)"
                                (mousedown)="onOperationClick($event, operation)"
                                (click)="onRowSelected(entry, operation)"
                            >
                            </td>
                        </ng-container>
                        <td *ngFor="let operation of dirEntry.operations" appProcColOperation

                            [entry]="dirEntry"
                            [operation]="operation"

                            (mouseenter)="onOperationMouseEnter($event, operation)"
                            (mouseleave)="onOperationMouseLeave($event, operation)"
                            (mouseover)="onOperationMouseOver($event, operation)"
                            (mousedown)="onOperationClick($event, operation)"
                            (click)="onRowSelected(dirEntry, operation)">
                        </td>
                    </tr>
                </ng-container>
            </ng-container>
            <!-- Queue rows -->
            <ng-container *ngFor="let entry of queue; let i = index;">
                <tr style="cursor:pointer;" [ngClass]="{'selected': (isEntrySelected(entry))}">
                    <td *ngIf="entry.file.entries === undefined"
                        [ngClass]="{'shorten': shortstyle}">
                        <ng-container *ngIf="entry.file.entries === undefined">
                            <i class="fa fa-file-audio-o op-50"
                               aria-hidden="true">
                            </i>
                        </ng-container>
                        <ng-container *ngIf="entry.file.entries !== undefined" [ngClass]="{
                            'shorten': shortstyle
                        }">
                            <i class="fa fa-folder-open blue op-50" aria-hidden="true"></i>
                        </ng-container>
                        <span class="op-50"
                              title="{{entry.file.fullname}}"
                        >
                            {{entry.file.fullname}}  <i class="fa fa-spinner fa-spin"></i>
                        </span>
                    </td>
                    <td *ngIf="entry.file.entries !== undefined" [attr.colspan]="taskService.operations.length + 1">
                        <span title="{{entry.file.name}}" class="op-50">{{entry.file.name}}  <i
                                class="fa fa-spinner fa-spin"></i>
                        </span>
                    </td>
                    <ng-container *ngIf="entry.file.entries === undefined">
                        <td [attr.colspan]="taskService.operations.length + 1"></td>
                    </ng-container>
                </tr>
                <ng-container *ngIf="entry.file.entries !== undefined">
                    <tr *ngFor="let dirEntry of entry.file.entries">
                        <td>
                            <img style="height:20px;" src="./assets/directory.png" class="op-50">
                        </td>
                        <td>
                            <i class="fa fa-file-audio-o op-50" aria-hidden="true"></i>
                            <span class="op-50">{{dirEntry.fullname}}</span> <i class="fa fa-spinner fa-spin"></i>
                        </td>
                        <td [attr.colspan]="taskService.operations.length + 1"></td>
                    </tr>
                </ng-container>
            </ng-container>
            </tbody>
        </table>
    </ng-container>
</div>